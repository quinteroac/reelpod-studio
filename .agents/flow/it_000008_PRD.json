{
  "goals": [
    "Replace in-process ACEStep 1.3 inference with HTTP calls to the ACE-Step 1.5 REST API",
    "Provide a reusable startup script for the ACE-Step 1.5 API server",
    "Remove the `ace-step` direct dependency from the backend"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Startup script for ACE-Step 1.5 API",
      "description": "As a developer, I want a script that launches the ACE-Step 1.5 API server from the path specified by `ACE_STEP_API_HOME` so that I can start the ML backend independently.",
      "acceptanceCriteria": [
        {
          "id": "US-001-AC01",
          "text": "A shell script (e.g. `start-acestep.sh`) exists at the project root"
        },
        {
          "id": "US-001-AC02",
          "text": "The script reads the `ACE_STEP_API_HOME` environment variable to locate the ACE-Step 1.5 repo"
        },
        {
          "id": "US-001-AC03",
          "text": "The script exits with a clear error message if `ACE_STEP_API_HOME` is not set or the directory does not exist"
        },
        {
          "id": "US-001-AC04",
          "text": "The script runs `uv run acestep-api` inside the `ACE_STEP_API_HOME` directory to start the API on its default port (8001)"
        },
        {
          "id": "US-001-AC05",
          "text": "The script is executable (`chmod +x`)"
        }
      ]
    },
    {
      "id": "US-002",
      "title": "Backend calls ACE-Step 1.5 REST API instead of in-process pipeline",
      "description": "As a end user, I want audio generation to use ACE-Step 1.5 so that I get higher-quality lofi music.",
      "acceptanceCriteria": [
        {
          "id": "US-002-AC01",
          "text": "`backend/main.py` no longer imports `ACEStepPipeline` or any `acestep` module"
        },
        {
          "id": "US-002-AC02",
          "text": "`backend/main.py` sends a `POST` to `{ACESTEP_API_URL}/release_task` with JSON body containing `prompt`, `lyrics`, `audio_duration`, `inference_steps`, and `audio_format` fields"
        },
        {
          "id": "US-002-AC03",
          "text": "After submitting, the backend polls `POST {ACESTEP_API_URL}/query_result` with the returned `task_id` until `status == 1` (succeeded) or `status == 2` (failed)"
        },
        {
          "id": "US-002-AC04",
          "text": "On success, the backend parses the `result` JSON string from the poll response, extracts the `file` URL (e.g. `/v1/audio?path=...`), and fetches the raw audio bytes via `GET {ACESTEP_API_URL}{file}`"
        },
        {
          "id": "US-002-AC05",
          "text": "The ACE-Step 1.5 API base URL is configurable via `ACESTEP_API_URL` env var, defaulting to `http://localhost:8001`"
        },
        {
          "id": "US-002-AC06",
          "text": "The prompt template (`\"{mood} lofi {style}, {tempo} BPM\"`) is preserved and sent in the `prompt` field"
        },
        {
          "id": "US-002-AC07",
          "text": "Existing parameters are mapped: `lyrics=\"\"`, `audio_duration=30`, `inference_steps=20`, `audio_format=\"wav\"`"
        },
        {
          "id": "US-002-AC08",
          "text": "The endpoint still returns a WAV `StreamingResponse` to the frontend"
        },
        {
          "id": "US-002-AC09",
          "text": "Errors from the ACE-Step 1.5 API (connection refused, non-OK status, task failure) are caught and returned as HTTP 500 with `\"Audio generation failed\"`"
        },
        {
          "id": "US-002-AC10",
          "text": "The FastAPI lifespan no longer loads a model at startup"
        }
      ]
    },
    {
      "id": "US-003",
      "title": "Remove ace-step dependency from backend",
      "description": "As a developer, I want the `ace-step` package removed from backend dependencies so that the backend is lightweight and does not bundle the ML model.",
      "acceptanceCriteria": [
        {
          "id": "US-003-AC01",
          "text": "`ace-step` is removed from `backend/pyproject.toml` dependencies"
        },
        {
          "id": "US-003-AC02",
          "text": "`backend/uv.lock` is regenerated without `ace-step`"
        },
        {
          "id": "US-003-AC03",
          "text": "An HTTP client library (e.g. `httpx`) is added to `backend/pyproject.toml` if needed for calling the ACE-Step 1.5 API"
        },
        {
          "id": "US-003-AC04",
          "text": "Typecheck / lint passes"
        }
      ]
    }
  ],
  "functionalRequirements": [
    {
      "id": "FR-1",
      "description": "The startup script must use `ACE_STEP_API_HOME` env var to locate the ACE-Step 1.5 installation and run `uv run acestep-api` from that directory."
    },
    {
      "id": "FR-2",
      "description": "The backend must call the ACE-Step 1.5 REST API over HTTP using an async 3-step flow: (1) `POST /release_task` to submit, (2) `POST /query_result` to poll until done, (3) `GET /v1/audio?path=...` to download the WAV bytes."
    },
    {
      "id": "FR-3",
      "description": "The ACE-Step 1.5 API base URL must be configurable via `ACESTEP_API_URL` env var, defaulting to `http://localhost:8001`."
    },
    {
      "id": "FR-4",
      "description": "The existing `/api/generate` request/response contract (accepts `{mood, tempo, style}`, returns WAV audio) must remain unchanged from the frontend's perspective."
    },
    {
      "id": "FR-5",
      "description": "The `ace-step` Python package must be removed from `backend/pyproject.toml`."
    }
  ]
}
