{
  "goals": [
    "Separate HTTP routing, business logic, and external I/O into distinct, independently testable modules.",
    "Preserve the existing public HTTP API (no endpoint, request schema, or response schema changes).",
    "Increase test coverage by enabling unit tests for the service and repository layers in isolation.",
    "Update the project context to reflect the new backend architecture."
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Split `main.py` into Route, Service, and Repository Modules",
      "description": "As a developer, I want the backend source split across `routes/`, `services/`, and `repositories/` sub-packages so that each layer has a single, well-defined responsibility.",
      "acceptanceCriteria": [
        {
          "id": "US-001-AC01",
          "text": "The following directory structure exists inside `backend/`:"
        },
        {
          "id": "US-001-AC02",
          "text": "`main.py` only creates the `FastAPI` app, registers `APIRouter`s, and registers `startup`/`shutdown` lifecycle events — no business logic or I/O."
        },
        {
          "id": "US-001-AC03",
          "text": "Route modules contain only FastAPI endpoint functions and exception handlers; they delegate to services."
        },
        {
          "id": "US-001-AC04",
          "text": "Service modules contain only business logic and orchestration; they call repositories but contain no `urllib` or ML pipeline calls."
        },
        {
          "id": "US-001-AC05",
          "text": "Repository modules contain all external I/O (`urllib` calls, `DiffusionPipeline` usage); they contain no business logic."
        },
        {
          "id": "US-001-AC06",
          "text": "Typecheck / lint passes."
        }
      ]
    },
    {
      "id": "US-002",
      "title": "Existing HTTP API Contract Is Preserved",
      "description": "As a developer, I want all existing endpoints to keep exactly the same URL, HTTP method, request schema, and response schema so that the frontend requires zero changes.",
      "acceptanceCriteria": [
        {
          "id": "US-002-AC01",
          "text": "`POST /api/generate` — accepts the same `GenerateRequestBody` schema, returns `audio/wav` stream."
        },
        {
          "id": "US-002-AC02",
          "text": "`POST /api/generate-requests` — same request schema, returns `{ id, status }`."
        },
        {
          "id": "US-002-AC03",
          "text": "`GET /api/generate-requests/{item_id}` — returns `{ id, status, error }`."
        },
        {
          "id": "US-002-AC04",
          "text": "`GET /api/generate-requests/{item_id}/audio` — returns `audio/wav` stream."
        },
        {
          "id": "US-002-AC05",
          "text": "`POST /api/generate-image` — accepts the same `GenerateImageRequestBody` schema, returns `image/png` stream."
        },
        {
          "id": "US-002-AC06",
          "text": "All existing `test_main.py` tests pass without modification (no test code changes for this story)."
        },
        {
          "id": "US-002-AC07",
          "text": "Typecheck / lint passes."
        }
      ]
    },
    {
      "id": "US-003",
      "title": "Unit Tests for the Service Layer",
      "description": "As a developer, I want isolated unit tests for the service layer so that business logic can be verified without standing up HTTP or ML infrastructure.",
      "acceptanceCriteria": [
        {
          "id": "US-003-AC01",
          "text": "A test file `backend/test_audio_service.py` (or equivalent co-located file) covers at minimum:"
        },
        {
          "id": "US-003-AC02",
          "text": "`build_prompt` produces the correct string for `params`, `text`, `text+params`, and `text-and-parameters` modes."
        },
        {
          "id": "US-003-AC03",
          "text": "`enqueue_generation_request` adds an item to the queue with status `\"queued\"`."
        },
        {
          "id": "US-003-AC04",
          "text": "`wait_for_terminal_status` returns the item once its status is `\"completed\"` or `\"failed\"`."
        },
        {
          "id": "US-003-AC05",
          "text": "Queue worker processes items sequentially (max one active at a time) and transitions statuses correctly (`queued` → `generating` → `completed`/`failed`)."
        },
        {
          "id": "US-003-AC06",
          "text": "Tests mock repository functions; no real HTTP calls or ML model loads occur."
        },
        {
          "id": "US-003-AC07",
          "text": "All new tests pass."
        },
        {
          "id": "US-003-AC08",
          "text": "Typecheck / lint passes."
        }
      ]
    },
    {
      "id": "US-004",
      "title": "Unit Tests for the Repository Layer",
      "description": "As a developer, I want isolated unit tests for the repository layer so that external I/O adapters can be verified independently of business logic.",
      "acceptanceCriteria": [
        {
          "id": "US-004-AC01",
          "text": "A test file `backend/test_acestep_repository.py` (or equivalent co-located file) covers at minimum:"
        },
        {
          "id": "US-004-AC02",
          "text": "`submit_task` sends the correct JSON payload to `POST /release_task` and returns the `task_id`."
        },
        {
          "id": "US-004-AC03",
          "text": "`poll_until_complete` polls `POST /query_result` and returns the completed task on status `1`."
        },
        {
          "id": "US-004-AC04",
          "text": "`poll_until_complete` raises on ACEStep failure status `2`."
        },
        {
          "id": "US-004-AC05",
          "text": "`get_bytes` fetches a URL via `GET` and returns its body."
        },
        {
          "id": "US-004-AC06",
          "text": "Tests use a fake/stub for `urlopen`; no real network calls are made."
        },
        {
          "id": "US-004-AC07",
          "text": "All new tests pass."
        },
        {
          "id": "US-004-AC08",
          "text": "Typecheck / lint passes."
        }
      ]
    },
    {
      "id": "US-005",
      "title": "Update Project Context",
      "description": "As a developer, I want `PROJECT_CONTEXT.md` updated to describe the new backend module structure so that future agents and contributors understand the architecture without reading the source.",
      "acceptanceCriteria": [
        {
          "id": "US-005-AC01",
          "text": "`PROJECT_CONTEXT.md` → **Product Architecture** section describes the three-layer split (Routes, Services, Repositories) and the purpose of each layer."
        },
        {
          "id": "US-005-AC02",
          "text": "`PROJECT_CONTEXT.md` → **Modular Structure** section lists `backend/routes/`, `backend/services/`, `backend/repositories/` with a one-line description of each module."
        },
        {
          "id": "US-005-AC03",
          "text": "Old references to a monolithic `backend/main.py` are updated or removed where they no longer apply (entry point reference is retained — `main.py` is still the composition root)."
        },
        {
          "id": "US-005-AC04",
          "text": "Typecheck / lint passes (not a code file, but the document must be accurate)."
        }
      ]
    }
  ],
  "functionalRequirements": [
    {
      "id": "FR-1",
      "description": "** All FastAPI route functions must live in `backend/routes/` modules and use `APIRouter`. Routers are registered on the `FastAPI` app in `main.py`."
    },
    {
      "id": "FR-2",
      "description": "** Pydantic request/response models (`GenerateRequestBody`, `GenerateImageRequestBody`) and the `GenerationQueueItem` dataclass must live in `backend/models.py` and be imported by both routes and services."
    },
    {
      "id": "FR-3",
      "description": "** `backend/services/audio_service.py` must own: `build_prompt`, `enqueue_generation_request`, `wait_for_terminal_status`, `get_queue_item_snapshot`, `queue_worker`, `ensure_queue_worker_running`, `stop_queue_worker`, and `reset_generation_queue_for_tests`. All queue state (`queue_items`, `queue_order`, `queue_condition`, etc.) moves here."
    },
    {
      "id": "FR-4",
      "description": "** `backend/services/image_service.py` must own: `needs_image_refiner_pass` and `center_crop_and_resize_to_target`."
    },
    {
      "id": "FR-5",
      "description": "** `backend/repositories/acestep_repository.py` must own: `post_json`, `get_bytes`, `make_absolute_url`, `get_acestep_api_url`, `submit_task`, `poll_until_complete`, and `extract_file_path`. All ACEStep constants (`RELEASE_TASK_PATH`, `QUERY_RESULT_PATH`, `POLL_INTERVAL_SECONDS`, `MAX_POLL_ATTEMPTS`, `DEFAULT_ACESTEP_API_URL`) move here."
    },
    {
      "id": "FR-6",
      "description": "** `backend/repositories/image_pipeline_repository.py` must own: `load_image_pipeline`, the `image_pipeline` and `image_model_load_error` module-level state, and the `IMAGE_MODEL_ID`, `IMAGE_SIZE`, `IMAGE_NUM_INFERENCE_STEPS`, `IMAGE_ASPECT_TOLERANCE` constants."
    },
    {
      "id": "FR-7",
      "description": "** `main.py` retains only: `FastAPI` app instantiation, router registration, `startup` and `shutdown` event handlers, and the `INVALID_PAYLOAD_ERROR` constant used by the global `RequestValidationError` handler."
    },
    {
      "id": "FR-8",
      "description": "** `backend/routes/generate.py` handles `POST /api/generate`, `POST /api/generate-requests`, `GET /api/generate-requests/{item_id}`, and `GET /api/generate-requests/{item_id}/audio`."
    },
    {
      "id": "FR-9",
      "description": "** `backend/routes/images.py` handles `POST /api/generate-image`."
    },
    {
      "id": "FR-10",
      "description": "** Existing `test_main.py` must continue to pass without any modifications to its test logic (import paths for mocked symbols may be updated to reflect their new module locations)."
    }
  ]
}
